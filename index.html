<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="/">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Award winning dating events app">

  <!-- iOS meta tags & icons -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="flutter_boilerplate">
  <script src="https://apis.google.com/js/platform.js" async defer></script>
  <meta name="google-signin-client_id" content="997346034018-l7jvt4j8iv3nrnejhm3v88508vkadnu5.apps.googleusercontent.com">
  <script>
    function initializeGapi() {
      gapi.load('auth2', function() {
        gapi.auth2.init({
          client_id: '997346034018-l7jvt4j8iv3nrnejhm3v88508vkadnu5.apps.googleusercontent.com',
        });
      });
    }

    window.onload = initializeGapi;
  </script>
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="icons/events121/icon.png"/>

  <title>Events121</title>
  <link rel="manifest" href="manifest.json">

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-J1V3R5RJV8"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-J1V3R5RJV8');
  </script>
  <!-- Stripe.js for web payments -->
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    // Global Stripe instances
    window.stripeWebInstance = null;
    window.stripeElements = null;
    window.cardElement = null;
    
    // Initialize Stripe with publishable key
    window.initializeStripeForWeb = function(publishableKey) {
      try {
        window.stripeWebInstance = Stripe(publishableKey);
        window.stripeElements = window.stripeWebInstance.elements();
        console.log('Stripe initialized');
        return true;
      } catch (error) {
        console.error('Failed to initialize Stripe for web:', error);
        return false;
      }
    };

    // Create and mount Stripe Elements card element
    window.createCardElement = function(elementId) {
      try {
        if (!window.stripeElements) {
          console.error('Stripe Elements not initialized');
          return false;
        }

        // Destroy existing card element if it exists
        if (window.cardElement) {
          window.cardElement.destroy();
        }

        // Create card element with styling
        window.cardElement = window.stripeElements.create('card', {
          style: {
            base: {
              fontSize: '16px',
              color: '#424770',
              '::placeholder': {
                color: '#aab7c4',
              },
            },
            invalid: {
              color: '#9e2146',
            },
          },
        });

        // Mount the card element to the container
        window.cardElement.mount('#' + elementId);

        // Listen for real-time validation errors
        window.cardElement.on('change', function(event) {
          const displayError = document.getElementById(elementId + '-errors');
          if (event.error) {
            if (displayError) {
              displayError.textContent = event.error.message;
            }
            // Notify Flutter about validation errors
            if (window.flutterCardValidation) {
              window.flutterCardValidation(false, event.error.message);
            }
          } else {
            if (displayError) {
              displayError.textContent = '';
            }
            // Notify Flutter about successful validation
            if (window.flutterCardValidation) {
              window.flutterCardValidation(event.complete, null);
            }
          }
        });

        console.log('Card element created');
        return true;
      } catch (error) {
        console.error('Failed to create card element:', error);
        return false;
      }
    };

    // Extract card data from Stripe Elements for server-side processing
    window.extractCardDataForCloudFunction = function(billingDetails) {
      return new Promise(async (resolve) => {
        try {
          if (!window.stripeWebInstance || !window.cardElement) {
            console.error('Stripe Elements not properly initialized');
            resolve({
              success: false,
              error: 'Stripe Elements not initialized'
            });
            return;
          }

          // Create a token to securely transfer card data to cloud function
          const result = await window.stripeWebInstance.createToken(window.cardElement, {
            name: billingDetails.name,
            email: billingDetails.email
          });

          if (result.error) {
            console.error('Stripe token creation error:', result.error);
            resolve({
              success: false,
              error: result.error.message
            });
          } else {
            resolve({
              success: true,
              token: {
                id: result.token.id,
                type: result.token.type,
                card: result.token.card ? {
                  brand: result.token.card.brand,
                  last4: result.token.card.last4,
                  exp_month: result.token.card.exp_month,
                  exp_year: result.token.card.exp_year,
                  country: result.token.card.country
                } : null
              }
            });
          }
        } catch (error) {
          console.error('Exception in extractCardDataForCloudFunction:', error);
          resolve({
            success: false,
            error: error.message || 'Unknown error occurred'
          });
        }
      });
    };

    // Create payment method using Stripe Elements (keep for fallback)
    window.createPaymentMethodWithElements = function(billingDetails) {
      return new Promise(async (resolve) => {
        try {
          console.log('Starting payment method creation with billing details:', billingDetails);
          
          if (!window.stripeWebInstance || !window.cardElement) {
            console.error('Stripe Elements not properly initialized');
            resolve({
              success: false,
              error: 'Stripe Elements not initialized'
            });
            return;
          }

          const result = await window.stripeWebInstance.createPaymentMethod({
            type: 'card',
            card: window.cardElement,
            billing_details: billingDetails
          });

          if (result.error) {
            console.error('Stripe payment method creation error:', result.error);
            resolve({
              success: false,
              error: result.error.message
            });
          } else {
            resolve({
              success: true,
              paymentMethod: {
                id: result.paymentMethod.id,
                type: result.paymentMethod.type,
                card: result.paymentMethod.card ? {
                  brand: result.paymentMethod.card.brand,
                  last4: result.paymentMethod.card.last4,
                  exp_month: result.paymentMethod.card.exp_month,
                  exp_year: result.paymentMethod.card.exp_year
                } : null
              }
            });
          }
        } catch (error) {
          console.error('Payment method creation error:', error);
          resolve({
            success: false,
            error: error.message || 'Failed to create payment method'
          });
        }
      });
    };

    // Clean up function
    window.destroyCardElement = function() {
      try {
        if (window.cardElement) {
          window.cardElement.destroy();
          window.cardElement = null;
        }
      } catch (error) {
        console.error('Error destroying card element:', error);
      }
    };
  </script>
</head>
<body>
  <script src="flutter_bootstrap.js" async></script>
  <script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkyoOQkXsMJMt7zw-gyuInIPU9Z3--Vxk&libraries=places"
  async
  defer>
</script>
</body>
</html>
